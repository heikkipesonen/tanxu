"use strict";function TouchEventHandler(){this.position={x:0,y:0},this.velocity={x:0,y:0},this.delta={x:0,y:0,t:0},this.step={x:0,y:0,t:0},this.timestamp=null}function RotateButton(a){this.element=a,this.value=0,this.rotation=0,this.last_rotation=0,this.position={top:0,left:0,width:0,height:0},this.last_update=0,this.options={stepsize:.1},this.init()}function dev(a,b){e.style.left=a+"px",e.style.top=b+"px"}angular.module("tankkausApp",["ngAnimate","ngResource","ngTouch","LocalStorageModule"]).constant("API_URL","backend"),TouchEventHandler.prototype={getPointerPosition:function(a){return a.touches?{x:a.touches[0].pageX,y:a.touches[0].pageY,t:a.timeStamp}:{x:a.pageX,y:a.pageY,t:a.timeStamp}},reset:function(a){var b=this.getPointerPosition(a);this.position.x=b.x,this.position.y=b.y,this.velocity.x=0,this.velocity.y=0,this.delta.x=0,this.delta.y=0,this.delta.t=0,this.step.x=0,this.step.y=0,this.step.t=0,this.timestamp=b.t},add:function(a){var b=this.getPointerPosition(a),c=b.x-this.position.x,d=b.y-this.position.y,e=b.t-this.timestamp;return this.position.x=b.x,this.position.y=b.y,this.velocity.x=c/e,this.velocity.y=d/e,this.step.t=e,this.step.x=c,this.step.y=d,this.delta.x+=c,this.delta.y+=d,this.delta.t+=e,this}},RotateButton.prototype={getPosition:function(){for(var a=this.element,b=0,c=0;a;)b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent;return this.position.top=c,this.position.left=b,this.position.width=220,this.position.height=220,{x:b,y:c}},init:function(){this.dragging=!1,this._touch=new TouchEventHandler,this._handleTouchStart=function(a){a.stopPropagation(),a.preventDefault(),this.getPosition(),document.addEventListener("mousemove",this._handleTouchMove),document.addEventListener("mouseup",this._handleTouchEnd),document.addEventListener("touchmove",this._handleTouchMove),document.addEventListener("touchend",this._handleTouchEnd),this.dragging=!0,this._touch.reset(a),this.last_rotation=this.getAngle()}.bind(this),this._handleTouchMove=function(a){this.dragging&&(a.stopPropagation(),a.preventDefault(),this._touch.add(a),this.update())}.bind(this),this._handleTouchEnd=function(){this.dragging=!1,document.removeEventListener("mousemove",this._handleTouchMove),document.removeEventListener("mouseup",this._handleTouchEnd),document.removeEventListener("touchmove",this._handleTouchMove),document.removeEventListener("touchend",this._handleTouchEnd)}.bind(this),this.element.addEventListener("mousedown",this._handleTouchStart),this.element.addEventListener("touchstart",this._handleTouchStart)},setStyle:function(){var a="rotate3d(0,0,1,"+this.rotation+"rad)";this.element.style.mozTransform=a,this.element.style.oTransform=a,this.element.style.webkitTransform=a,this.element.style.msTransform=a,this.element.style.transform=a},getAngle:function(){var a=this.position.top+this.position.height/2,b=this.position.left+this.position.width/2,c=b-this._touch.position.x,d=a-this._touch.position.y,e=Math.atan2(d,c);return e},onUpdate:function(){},update:function(){var a=this.getAngle(),b=a-this.last_rotation;this.rotation+=b;var c=this.options.stepsize,d=a-this.last_update,e=b>0?1:-1;Math.abs(d)>=c&&(this.onUpdate(e),this.last_update=a,this.value+=e),this.last_rotation=a,this.setStyle()}};var e=document.getElementById("dev");angular.module("tankkausApp").directive("rotate",function(){return{replace:!0,scope:{max:"=",value:"="},controller:"RotateCtrl",template:'<div class="rotate-wrapper"><div class="rotate-button" ng-transclude></div></div>',restrict:"A",transclude:!0,link:function(a){a.init()}}}),angular.module("tankkausApp").controller("RotateCtrl",["$scope","$element","$timeout",function(a,b,c){angular.extend(a,{init:function(){var d=new RotateButton(b[0].children[0]);a.value=d.value,d.onUpdate=function(b){var d=a.value+b;a.value=d>0?d:0,a.value=a.value<a.max?a.value:a.max,c(function(){})}}})}]),angular.module("tankkausApp").directive("indicator",function(){return{scope:{value:"=",max:"=",min:"=",direction:"@?",label:"@"},template:'<div class="indicator" ng-class="direction"><div class="indicator-bar" ng-style="style"></div><span class="indicator-value" ng-bind="label"></span></div>',restrict:"A",replace:!0,controller:["$scope",function(a){angular.extend(a,{style:{height:"100%",width:"100%"},update:function(){var b=a.max-a.min,c=a.value/b,d=100*c;d=0>d?0:100>d?d:100,"vertical"===a.direction?(a.style.height=d+"%",a.style.width="100%"):(a.style.width=d+"%",a.style.height="100%")}}),a.update(),a.$watch("value",function(){a.update()})}]}}),angular.module("tankkausApp").factory("Tank",["$http","API_URL","planeService",function(a,b,c){function d(a){this.busy=!1,this.id=null,this.min=0,this.max=0,this.name=null,this.value=null,this.log=[],this.take={value:0},a&&this.set(a)}return d.prototype={getLog:function(){var c=this;a.get(b+"/log/"+this.id).then(function(a){c.log=a.data},function(){alert("Logia ei nyt sitten saatu haettua..")})},set:function(a){this.id=a.id,this.name=a.name,this.min=parseInt(a.min),this.max=parseInt(a.max),this.value=parseInt(a.value),this.getLog()},fill:function(){var c=this;if(!this.busy)return this.busy=!0,a.post(b+"/fill/"+this.id).then(function(a){return c.value=a.data.value,c.busy=!1,c.getLog(),!0},function(){return c.busy=!1,!1})},takeFuel:function(){var d=this;return a.post(b+"/take/"+this.id,{value:this.take.value,register:c.register}).then(function(a){return d.value=a.data.value,d.take.value=0,d.busy=!1,d.getLog(),c.save(),!0},function(){return d.busy=!1,!1})}},d}]),angular.module("tankkausApp").controller("MainCtrl",["$scope","API_URL","$http","Tank","$timeout","localStorageService","planeService",function(a,b,c,d,e,f,g){angular.extend(a,{view:"view-main",tank:!1,plane:g,loading:!1,eventType:{0:"Täyttö",1:"Tank."},set:function(b){a.tank=a.tanks[b],e(function(){}),f.set("tanxu-tank",b)},setNext:function(){var b=a.tanks.indexOf(a.tank),c=b<a.tanks.length-1?b+1:0;a.set(c)},setPrev:function(){var b=a.tanks.indexOf(a.tank),c=b>0?b-1:a.tanks.length-1;a.set(c)},nextPlane:function(){g.next()},prevPlane:function(){g.prev()},fill:function(){var b=window.confirm("Täytä pouseri "+a.tank.name+"?");b&&(a.loading=!0,a.tank.fill().then(function(b){a.loading=!1,b===!1?alert("Ei täytetty, ku ei onnistunu :("):a.view="view-main"}))},getLog:function(){a.tank.getLog()},takeFuel:function(){a.tank&&g.register&&a.tank.take.value?(a.loading=!0,a.tank.takeFuel().then(function(b){a.loading=!1,b===!1&&alert("Ei tankattu ku ei onnistununna :(")})):alert("Pitäs laittaa rek nro ja tankattu määrä. kuitenni..")},get:function(){a.loading=!0,c.get(b+"/tank").then(function(b){a.tanks=[],a.loading=!1,angular.forEach(b.data,function(b){a.tanks.push(new d(b))});var c=f.get("tanxu-tank");a.set(void 0!==c&&null!==c&&c!==!1?c:0)},function(){a.loading=!1,alert("Ei saatu dataa. :(")})}}),g.load(),a.get()}]),angular.module("tankkausApp").service("planeService",["localStorageService",function(a){this.register=null,this.planes=["OH-CVZ","OH-JIK","CH-737"],this.next=function(){var a=this.planes.indexOf(this.register)+1;a>this.planes.length-1&&(a=0),this.register=this.planes[a]},this.prev=function(){var a=this.planes.indexOf(this.register)-1;0>a&&(a=this.planes.length-1),this.register=this.planes[a]},this.save=function(){a.set("tanxu-plane",this.register)},this.load=function(){this.register=a.get("tanxu-plane")}}]),angular.module("tankkausApp").directive("fullHeight",function(){return{restrict:"C",controller:["$scope","$element","$window",function(a,b,c){var d=angular.element(c);angular.extend(a,{init:function(){d.bind("resize",a.update),a.update()},update:function(){b[0].style["min-height"]=d.height()+"px"}}),a.$on("$destroy",function(){d.unbind("resize",a.update)})}],link:function(a){a.init()}}});